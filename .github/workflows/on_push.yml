name: Build Re:VIEW to make distribution file
# The workflow is triggered on pushes to the repository.
on:
  push:
  workflow_dispatch:
    inputs:
      target_dir:
        description: 'Re:VIEWãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¾‹: book1ï¼‰'
        required: false
        default: '.'
      config1:
        description: 'ç´™ç‰ˆRe:VIEW configãƒ•ã‚¡ã‚¤ãƒ«'
        required: false
        default: 'config.yml'
      config2:
        description: 'é›»å­ç‰ˆRe:VIEW configãƒ•ã‚¡ã‚¤ãƒ«'
        required: false
        default: 'config_ebook.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: vvakame/review:5.8

    steps:
    # uses v3 Stable version
    # https://github.com/actions/checkout
    - name: checkout source
      uses: actions/checkout@v4.2.2

    - name: Cache Ruby gems
      uses: actions/cache@v4
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-gems-

    - name: Cache npm modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install Ruby gems
      run: |
        bundle config set path 'vendor/bundle'
        bundle install --jobs 4 --retry 3

    - name: Install npm packages
      run: |
        npm install --unsafe-perm

    - name: Show target_dir and working dir
      run: |
        echo "target_dir: ${{ github.event.inputs.target_dir || '.' }}"
        cd "${{ github.event.inputs.target_dir || '.' }}"
        echo "pwd: $(pwd)"
        echo "Directory listing:"
        ls -al

    - name: Show available rake tasks
      run: |
        cd "${{ github.event.inputs.target_dir || '.' }}"
        cd ./articles
        bundle exec rake -T

    # Convert Markdown to Re:VIEW
    - name: Convert Markdown to Re:VIEW
      run: |
        cd "${{ github.event.inputs.target_dir || '.' }}"
        cd ./articles
        rake pandoc2review

    # Build Artifacts
    - name: Build PDF - config for paper book
      run: |
        cd "${{ github.event.inputs.target_dir || '.' }}"
        REVIEW_CONFIG_FILE="${{ github.event.inputs.config1 || 'config.yml' }}" npm run pdf
        mkdir -p /github/workspace/pdf
        for f in ./articles/*.pdf; do
          filename=$(basename "$f")
          [ -f "$f" ] && cp "$f" "/github/workspace/pdf/paperbook_${filename}"
        done

    - name: Build PDF - config for ebook
      run: |
        cd "${{ github.event.inputs.target_dir || '.' }}"
        REVIEW_CONFIG_FILE="${{ github.event.inputs.config1 || 'config-ebook.yml' }}" npm run pdf
        mkdir -p /github/workspace/pdf
        for f in ./articles/*.pdf; do
          filename=$(basename "$f")
          [ -f "$f" ] && cp "$f" "/github/workspace/pdf/ebook_${filename}"
        done

    - name: Upload paper book PDF
      uses: actions/upload-artifact@v4
      with:
        name: paperbook_${{ github.run_number }}
        path: /github/workspace/pdf/paperbook_*.pdf

    - name: Upload ebook PDF
      uses: actions/upload-artifact@v4
      with:
        name: ebook_${{ github.run_number }}
        path: /github/workspace/pdf/ebook_*.pdf

    - name: Comment PDF link on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const runNumber = context.runNumber;
          const runId = context.runId;

          const body = [
            "ğŸ“˜ ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
            "",
            `ğŸ”— [paperbook_${runNumber}.pdf](../../runs/${runId}?check_suite_focus=true#step:20:1)`,
            `ğŸ”— [ebook_${runNumber}.pdf](../../runs/${runId}?check_suite_focus=true#step:21:1)`,
            "",
            "ğŸ‘€ Actionsãƒšãƒ¼ã‚¸ã®ã€ŒArtifactsã€ã‹ã‚‰ç›´æ¥ç¢ºèªã§ãã¾ã™ã€‚"
          ].join("\\n");

          github.rest.issues.createComment({
            issue_number: pr.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });